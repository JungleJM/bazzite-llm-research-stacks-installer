FROM registry.fedoraproject.org/fedora:latest

ARG USERNAME=user
ARG USER_UID=1000
ARG USER_GID=1000

# Install dependencies (inside container only)
RUN dnf -y update && \
    dnf -y install \
        python3 \
        python3-pip \
        python3-virtualenv \
        git \
        gcc \
        gcc-c++ \
        make \
        cmake \
        mesa-libGL \
        mesa-libEGL \
        libX11 \
        libXext \
        libXrender \
        libXrandr \
        libXcursor \
        libXfixes \
        libXi \
        libXinerama \
        libXxf86vm \
        libdrm \
        libjpeg-turbo \
        zlib \
        git-core \
        which \
        procps-ng && \
    dnf clean all

# Create user and ComfyUI dir as root
RUN groupadd --gid ${USER_GID} ${USERNAME} && \
    useradd --uid ${USER_UID} --gid ${USER_GID} -m ${USERNAME} && \
    mkdir -p /opt/comfyui && \
    chown ${USER_UID}:${USER_GID} /opt/comfyui

USER ${USERNAME}
WORKDIR /home/${USERNAME}

# Default environment; tune if needed
ENV ROC_ENABLE_PRE_VEGA=1

# Entrypoint: create venv if missing, install deps, then run ComfyUI
ENTRYPOINT ["/bin/bash", "-lc", "\
  if [ ! -d /opt/comfyui ]; then \
      echo 'ERROR: /opt/comfyui is not mounted. Bind your ComfyUI dir.' >&2; \
      exit 1; \
  fi; \
  cd /opt/comfyui; \
  if [ ! -d venv ]; then \
      echo 'Creating Python venv and installing dependencies...'; \
      python3 -m venv venv; \
      source venv/bin/activate; \
      pip install --upgrade pip; \
      if [ -f requirements.txt ]; then \
          pip install -r requirements.txt; \
      else \
          pip install torch torchvision --index-url https://download.pytorch.org/whl/rocm6.0; \
          pip install -r requirements.txt || true; \
      fi; \
  else \
      source venv/bin/activate; \
  fi; \
  echo 'Starting ComfyUI on 0.0.0.0:8188...'; \
  python main.py --listen 0.0.0.0 --port 8188 \
"]
